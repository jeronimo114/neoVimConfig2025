-- Set leader key to space
vim.g.mapleader = " "
vim.g.maplocalleader = " "

-- Yank to Clipboard
vim.opt.clipboard = "unnamedplus"

-- Enable line numbers
vim.o.number = true               -- Show absolute line numbers
vim.o.relativenumber = true       -- Show relative line numbers

-- Tabs and indentation
vim.o.tabstop = 4                 -- Number of spaces that a tab represents
vim.o.shiftwidth = 4              -- Number of spaces used for indentation
vim.o.expandtab = true            -- Use spaces instead of tabs
vim.o.autoindent = true           -- Auto-indent new lines

-- Search settings
vim.o.ignorecase = true           -- Ignore case when searching
vim.o.smartcase = true            -- Override ignorecase if search has uppercase
vim.o.hlsearch = false            -- Do not highlight search results

-- Appearance
vim.o.termguicolors = true        -- Enable true color support
vim.o.cursorline = true           -- Highlight the current line

-- Splits
vim.o.splitright = true           -- Open vertical splits to the right
vim.o.splitbelow = true           -- Open horizontal splits below

-- Save undo history
vim.o.undofile = true             -- Enable persistent undo
vim.opt.undodir = os.getenv("HOME") .. "/.config/nvim/undo"

-- Enable backups
vim.opt.backup = true
vim.opt.backupdir = os.getenv("HOME") .. "/.config/nvim/backup"

-- Enable swap files
vim.opt.swapfile = true
vim.opt.directory = os.getenv("HOME") .. "/.config/nvim/swap"

-- Enable writebackup
vim.opt.writebackup = true

-- Confirmation prompts when closing unsaved buffers
vim.opt.confirm = true

-- Automatically save before certain actions
vim.opt.autowrite = true

-- Initialize vim-plug
vim.cmd [[
call plug#begin('~/.local/share/nvim/plugged')

" Essential Plugins
Plug 'nvim-lua/plenary.nvim'

" File explorer
Plug 'nvim-tree/nvim-tree.lua'

" Syntax highlighting and more
Plug 'nvim-treesitter/nvim-treesitter'

" Status line
Plug 'nvim-lualine/lualine.nvim'

" Fuzzy finder
Plug 'nvim-telescope/telescope.nvim'

" Git integration
Plug 'tpope/vim-fugitive'

" Auto-save plugin
Plug 'Pocco81/auto-save.nvim'

" Autocomplete plugins
Plug 'hrsh7th/nvim-cmp'         " Autocompletion plugin
Plug 'hrsh7th/cmp-nvim-lsp'     " LSP source for nvim-cmp
Plug 'hrsh7th/cmp-buffer'       " Buffer completions
Plug 'hrsh7th/cmp-path'         " Path completions
Plug 'saadparwaiz1/cmp_luasnip' " Snippet completions

" Snippet engine
Plug 'L3MON4D3/LuaSnip'

" Mason for managing LSP servers
Plug 'williamboman/mason.nvim'
Plug 'williamboman/mason-lspconfig.nvim'

" LSP Configuration
Plug 'neovim/nvim-lspconfig'

" Enhanced Colorscheme
Plug 'folke/tokyonight.nvim'

" Optional: Friendly Snippets
Plug 'rafamadriz/friendly-snippets'

call plug#end()
]]

-- Colorscheme setup
vim.cmd[[colorscheme tokyonight]]

-- nvim-tree setup with auto-close functionality
require("nvim-tree").setup {
    -- Disable the built-in netrw (optional but recommended)
    disable_netrw = true,
    hijack_netrw = true,

    -- Renderer settings
    renderer = {
        highlight_git = true,
        icons = {
            glyphs = {
                default = "",
                symlink = "",
                git = {
                    unstaged = "✗",
                    staged = "✓",
                    unmerged = "",
                    renamed = "➜",
                    untracked = "★",
                    deleted = "",
                    ignored = "◌",
                },
            },
        },
    },

    -- Update focused file on the tree
    update_focused_file = {
        enable = true,
        update_cwd = true,
    },

    -- Actions related to opening files
    actions = {
        open_file = {
            quit_on_open = false,  -- We'll handle closing manually
            resize_window = false,
        },
    },

    -- View settings without 'mappings'
    view = {
        width = 30,
        side = 'left',
        -- Removed 'mappings' as it's no longer a valid option
    },

    -- Attach function to set up key mappings specific to nvim-tree
    on_attach = function(bufnr)
        local api = require("nvim-tree.api")

        local function opts(desc)
            return { desc = "nvim-tree: " .. desc, buffer = bufnr, noremap = true, silent = true, nowait = true }
        end

        -- Override the default <CR> mapping to open the file and close the tree
        vim.keymap.set('n', '<CR>', function()
            api.node.open.edit()
            api.tree.close()
        end, opts('Open and Close'))

        -- Similarly, override other mappings if desired
        vim.keymap.set('n', 'o', function()
            api.node.open.edit()
            api.tree.close()
        end, opts('Open and Close'))

        vim.keymap.set('n', '<2-LeftMouse>', function()
            api.node.open.edit()
            api.tree.close()
        end, opts('Open and Close'))
    end,
}

-- Keymap to toggle file explorer
vim.keymap.set("n", "<C-n>", ":NvimTreeToggle<CR>", { noremap = true, silent = true })

-- Treesitter setup with rainbow parentheses
require("nvim-treesitter.configs").setup {
    ensure_installed = { "lua", "python", "javascript", "html", "css" }, -- Add languages you need
    highlight = { 
        enable = true,
        additional_vim_regex_highlighting = false,
    },
    indent = { enable = true },
    rainbow = {
        enable = true,
        extended_mode = true, -- Highlight also non-bracket delimiters
        max_file_lines = nil,
    },
}

-- Lualine setup
require("lualine").setup {
    options = {
        theme = "tokyonight", -- Updated to match the new colorscheme
        section_separators = "",
        component_separators = "",
    },
}

-- Telescope setup with initial_mode set to normal
require('telescope').setup{
    defaults = {
        initial_mode = "normal", -- Start in normal mode
        mappings = {
            i = {
                ["<C-j>"] = "move_selection_next",
                ["<C-k>"] = "move_selection_previous",
                ["<esc>"] = require('telescope.actions').close,
            },
            n = {
                ["<esc>"] = require('telescope.actions').close,
            },
        },
    },
    pickers = {
        -- You can add custom picker configurations here
    },
    extensions = {
        -- You can add extensions here
    },
}

-- Key mappings for Telescope
local builtin = require("telescope.builtin")
vim.keymap.set("n", "<leader>ff", builtin.find_files, { desc = "Find files" })
vim.keymap.set("n", "<leader>fg", builtin.live_grep, { desc = "Live grep" })
vim.keymap.set("n", "<leader>fb", builtin.buffers, { desc = "Find buffers" })
vim.keymap.set("n", "<leader>fh", builtin.help_tags, { desc = "Find help tags" })

-- Mason and mason-lspconfig setup
require("mason").setup()
require("mason-lspconfig").setup({
    ensure_installed = { "pyright", "lua_ls", "gopls", "rust_analyzer" }, -- Add more as needed
    automatic_installation = true,
})

-- Import lspconfig
local lspconfig = require('lspconfig')

-- Define capabilities for nvim-cmp
local cmp_nvim_lsp = require('cmp_nvim_lsp')
local capabilities = cmp_nvim_lsp.default_capabilities(vim.lsp.protocol.make_client_capabilities())

-- Setup for Python (pyright)
lspconfig.pyright.setup{
    capabilities = capabilities,
    on_attach = function(client, bufnr)
        -- Puedes agregar keybindings o funciones adicionales aquí
    end,
}

-- Setup for JavaScript/TypeScript (tsserver)
lspconfig.tsserver.setup{
    capabilities = capabilities,
    on_attach = function(client, bufnr)
        -- Disable tsserver formatting to use another formatter (e.g., prettier)
        client.server_capabilities.documentFormattingProvider = false
        client.server_capabilities.documentRangeFormattingProvider = false
    end,
}

-- Setup for Lua (lua_ls)
lspconfig.lua_ls.setup{
    capabilities = capabilities,
    settings = {
        Lua = {
            runtime = {
                version = 'LuaJIT', -- Neovim uses LuaJIT
            },
            diagnostics = {
                globals = {'vim'}, -- Recognize the `vim` global
            },
            workspace = {
                library = vim.api.nvim_get_runtime_file("", true),
                checkThirdParty = false,
            },
            telemetry = {
                enable = false,
            },
        }
    },
}

-- Setup for Go (gopls)
lspconfig.gopls.setup{
    capabilities = capabilities,
    on_attach = function(client, bufnr)
        -- Configuraciones específicas para Go
    end,
}

-- Setup for Rust (rust_analyzer)
lspconfig.rust_analyzer.setup{
    capabilities = capabilities,
    on_attach = function(client, bufnr)
        -- Configuraciones específicas para Rust
    end,
}

-- Autocompletion setup using nvim-cmp
local cmp = require'cmp'

cmp.setup({
    snippet = {
        -- REQUIRED: Configure snippet engine
        expand = function(args)
            require('luasnip').lsp_expand(args.body) -- For `luasnip` users.
        end,
    },
    mapping = cmp.mapping.preset.insert({
        ['<C-b>'] = cmp.mapping.scroll_docs(-4),
        ['<C-f>'] = cmp.mapping.scroll_docs(4),
        ['<C-Space>'] = cmp.mapping.complete(),
        ['<C-e>'] = cmp.mapping.abort(),
        ['<CR>'] = cmp.mapping.confirm({ select = false }), -- Confirm selection
        ['<Tab>'] = cmp.mapping(function(fallback)
            if cmp.visible() then
                cmp.select_next_item()
            elseif require('luasnip').expand_or_jumpable() then
                require('luasnip').expand_or_jump()
            else
                fallback()
            end
        end, { 'i', 's' }),

        ['<S-Tab>'] = cmp.mapping(function(fallback)
            if cmp.visible() then
                cmp.select_prev_item()
            elseif require('luasnip').jumpable(-1) then
                require('luasnip').jump(-1)
            else
                fallback()
            end
        end, { 'i', 's' }),
    }),
    sources = cmp.config.sources({
        { name = 'nvim_lsp' },        -- LSP completions
        { name = 'luasnip' },         -- Snippets
    }, {
        { name = 'buffer' },          -- Buffer completions
        { name = 'path' },            -- Path completions
    }),
    formatting = {
        format = function(entry, vim_item)
            -- Customize how completion items are displayed
            vim_item.kind = string.format('%s', vim_item.kind)
            vim_item.menu = ({
                nvim_lsp = "[LSP]",
                luasnip = "[Snippet]",
                buffer = "[Buffer]",
                path = "[Path]",
            })[entry.source.name]
            return vim_item
        end
    },
    experimental = {
        ghost_text = true, -- Show ghost text (inline suggestions)
        native_menu = false,
    },
})

-- Use buffer source for `/` and `?` in command-line mode
cmp.setup.cmdline({ '/', '?' }, {
    mapping = cmp.mapping.preset.cmdline(),
    sources = {
        { name = 'buffer' }
    }
})

-- Use cmdline & path source for ':' in command-line mode
cmp.setup.cmdline(':', {
    mapping = cmp.mapping.preset.cmdline(),
    sources = cmp.config.sources({
        { name = 'path' }
    }, {
        { name = 'cmdline' }
    })
})

-- LuaSnip setup
local luasnip = require 'luasnip'

-- Load friendly-snippets or your custom snippets
require("luasnip.loaders.from_vscode").lazy_load()

-- Optional: Define your own snippets here
-- Example:
-- luasnip.snippets = {
--   lua = {
--     luasnip.parser.parse_snippet("fn", "function() \n\t$1 \nend"),
--   },
-- }

-- Autocommand to close nvim-tree when it's the last window
vim.api.nvim_create_autocmd("BufEnter", {
    callback = function()
        local api = require("nvim-tree.api")
        if #vim.api.nvim_list_wins() == 1 and require("nvim-tree.utils").is_nvim_tree_buf() then
            vim.cmd("quit")
        end
    end,
    group = vim.api.nvim_create_augroup("NvimTreeCloseOnOpen", { clear = true }),
})

-- Auto-save setup
require("auto-save").setup {
    enabled = true, -- Start auto-save when the plugin is loaded
    execution_message = {
        message = "AutoSave: saved at " .. vim.fn.strftime("%H:%M:%S"),
        dim = 0.18,
        cleaning_interval = 1000,
    },
    trigger_events = {"InsertLeave", "TextChanged"}, -- Auto-save on these events
    condition = function(buf)
        local fn = vim.fn
        -- Don't auto-save if it's a terminal buffer
        if fn.getbufvar(buf, "&buftype") == "terminal" then
            return false
        end
        -- Don't auto-save if the buffer is not modifiable
        if not vim.bo[buf].modifiable then
            return false
        end
        -- Optionally, exclude certain filetypes
        local excluded_filetypes = {"gitcommit", "gitrebase"}
        if vim.tbl_contains(excluded_filetypes, vim.bo[buf].filetype) then
            return false
        end
        return true
    end,
    write_all_buffers = false, -- If true, all buffers will be written
    debounce_delay = 135, -- Delay in ms
}

-- Keymap to save all and quit
vim.keymap.set("n", "<leader>q", ":wqall<CR>", { noremap = true, silent = true, desc = "Save all and quit" })

-- Keybindings for saving
-- Save the current buffer
vim.keymap.set("n", "<leader>w", ":w<CR>", { noremap = true, silent = true, desc = "Save Current Buffer" })

-- Save all buffers
vim.keymap.set("n", "<leader>S", ":wa<CR>", { noremap = true, silent = true, desc = "Save All Buffers" })

